// Prisma schema for Classroom Check-In/Out System
// See SPEC.md for complete data model documentation

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// User (Teacher) model
model User {
  id            String         @id @default(cuid())
  email         String         @unique
  name          String?        // Encrypted at rest
  passwordHash  String
  pinHash       String?        // Optional hashed PIN for kiosk lock
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  classrooms    Classroom[]
  passkeys      Passkey[]
  googleAccount GoogleAccount?
}

// Google Account for Classroom API access (import only, not login)
model GoogleAccount {
  id           String    @id @default(cuid())
  userId       String    @unique
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken  String    // Encrypted at rest
  refreshToken String?   // Encrypted at rest
  expiresAt    DateTime?
  scope        String
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([userId])
}

// Passkey model for WebAuthn authentication
model Passkey {
  id                  String    @id @default(cuid())
  userId              String
  user                User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  credentialId        String    @unique // Base64URL-encoded credential ID
  credentialPublicKey Bytes               // Raw public key bytes
  counter             BigInt    @default(0)
  deviceType          String    @default("singleDevice")
  backedUp            Boolean   @default(false)
  transports          String?             // JSON array of transport hints
  name                String    @default("My Passkey")
  createdAt           DateTime  @default(now())
  lastUsedAt          DateTime?

  @@index([userId])
}

// Classroom model
model Classroom {
  id              String             @id @default(cuid())
  name            String
  teacherId       String
  teacher         User               @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  isActive        Boolean            @default(true)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  students        ClassroomStudent[]
  checkIns        CheckIn[]
  destinations    Destination[]
  waitListEntries WaitListEntry[]
}

// Student model
// Names are encrypted at rest for FERPA compliance
model Student {
  id              String             @id @default(cuid())
  firstName       String             // Encrypted at rest
  lastName        String             // Encrypted at rest
  cardId          String             @unique @default(cuid()) // UUID for QR code (not encrypted - not PII)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  classrooms      ClassroomStudent[]
  checkIns        CheckIn[]
  waitListEntries WaitListEntry[]
}

// Join table for many-to-many relationship between Student and Classroom
model ClassroomStudent {
  id          String    @id @default(cuid())
  studentId   String
  student     Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  classroomId String
  classroom   Classroom @relation(fields: [classroomId], references: [id], onDelete: Cascade)
  enrolledAt  DateTime  @default(now())

  @@unique([studentId, classroomId])
  @@index([classroomId])
  @@index([studentId])
}

// CheckIn/CheckOut record model
model CheckIn {
  id             String    @id @default(cuid())
  studentId      String
  student        Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  classroomId    String
  classroom      Classroom @relation(fields: [classroomId], references: [id], onDelete: Cascade)
  checkOutAt     DateTime  @default(now())
  checkInAt      DateTime? // Null if still checked out
  destination    String?   // Where student went (e.g., "Bathroom", "Office")
  manualOverride Boolean   @default(false) // True if teacher manually adjusted
  createdAt      DateTime  @default(now())

  @@index([classroomId, checkInAt])
  @@index([studentId])
}

// Destination model for checkout locations
model Destination {
  id              String          @id @default(cuid())
  classroomId     String
  classroom       Classroom       @relation(fields: [classroomId], references: [id], onDelete: Cascade)
  name            String
  sortOrder       Int             @default(0)
  isActive        Boolean         @default(true)
  capacity        Int?            // null = unlimited, 1+ = max students out at once
  createdAt       DateTime        @default(now())
  waitListEntries WaitListEntry[]

  @@unique([classroomId, name])
  @@index([classroomId])
}

// WaitListEntry model for students waiting for a destination
model WaitListEntry {
  id            String      @id @default(cuid())
  studentId     String
  student       Student     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  classroomId   String
  classroom     Classroom   @relation(fields: [classroomId], references: [id], onDelete: Cascade)
  destinationId String
  destination   Destination @relation(fields: [destinationId], references: [id], onDelete: Cascade)
  position      Int         // Queue position (1 = first in line)
  status        String      @default("waiting") // waiting, approved, checked_out, cancelled
  createdAt     DateTime    @default(now())
  approvedAt    DateTime?   // When promoted to approved status

  @@index([classroomId, destinationId, status])
  @@index([studentId, classroomId])
}
